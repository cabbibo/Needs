<html>

  <head>
    <link rel="stylesheet" type="text/css" href="main.css">
    
   <style>
    
    @font-face {
      font-family: "GeoSans";
      src: url( "lib/GeosansLight.ttf" );
    }
    
    html{ color:#fff; background:#000; font-family:"GeoSans" }

    #GUI{

      position:fixed;
      right:0px;
      top:0px;
      z-index:999;

    }

  </style>
 
</head>
<body>

  <div id="loading"> LOADING </div>

  <div id="GUI"></div>

<script src = "lib/leap.js"               ></script>
<script src = "lib/underscore.js"         ></script>
<script src = "lib/three.js"              ></script>
<script src = "lib/dat.gui.min.js"         ></script>
<script src = "lib/jquery.min.js"         ></script>
<script src = "lib/stats.min.js"          ></script>
<script src = "lib/TrackballControls.js"  ></script>
<script src = "lib/ShaderLoader.js"       ></script>
<script src = "lib/Stream.js"             ></script>
<script src = "lib/UserAudio.js"          ></script>
<script src = "lib/AudioController.js"    ></script>
<script src = "lib/AudioTexture.js"       ></script>
<script src = "lib/PhysicsRenderer.js"    ></script>
<script src = "lib/TextCreator.js"        ></script>

<script src = "lib/Loader.js"             ></script>
<script src = "lib/LoadedAudio.js"        ></script>

<script src = "js/ObjectRotator.js"       ></script>
<script src = "js/Tendrils.js"            ></script>
<script src = "js/Link.js"                ></script>
<script src = "js/LinkArch.js"            ></script>
<script src = "js/mechanics.js"           ></script>
<script src = "js/addSocialMedia.js"     ></script>


<script>

  var loader = new Loader();

  var T_IRI = {}


  var cb = function(){
    loader.endLoading(); 
  }
  var m = THREE.UVMapping;

  var i = 'img/iri/';
  var l = THREE.ImageUtils.loadTexture;
  
  T_IRI.red           = l( i + 'red.png'            , m , cb );
  T_IRI.turq          = l( i + 'turq.png'           , m , cb );
  T_IRI.pinkRed       = l( i + 'pinkRed.png'        , m , cb );
  T_IRI.gold          = l( i + 'gold.png'           , m , cb );
  T_IRI.combo         = l( i + 'combo.png'          , m , cb );
  T_IRI.yellowPurp    = l( i + 'neonYellowPurp.png' , m , cb );
  T_IRI.wet           = l( i + 'greenBluePurp.png'  , m , cb );
  T_IRI.orangeTurq    = l( i + 'orangeTurq.png'     , m , cb );
  T_IRI.purpleBright  = l( i + 'purpleBright.png'   , m , cb );
  T_IRI.blue          = l( i + 'blue.png'           , m , cb );
  T_IRI.rainbow       = l( i + 'rainbow.png'        , m , cb );
  T_IRI.rainbowLight  = l( i + 'rainbowLight.png'   , m , cb );
  T_IRI.turq2         = l( i + 'turq2.png'          , m , cb );

  var T_IRI_STRINGS = [];

  for( var propt in T_IRI ){

    T_IRI_STRINGS.push( propt );
    loader.beginLoading();
    

  }

  var T_NORM = {};

  var n = 'img/normals/';

  T_NORM.carbon = l( n + 'carbonFiber.png'    , m , cb );
  T_NORM.snow   = l( n + 'ice-snow.jpg'       , m , cb );
  T_NORM.sand   = l( n + 'sand.png'           , m , cb );
  T_NORM.ice    = l( n + '7723-normal.jpg'    , m , cb );
  T_NORM.moss   = l( n + 'moss_normal_map.jpg', m , cb );

  var T_NORM_STRINGS = [];

  for( var propt in T_NORM ){

    loader.beginLoading();    
    T_NORM[ propt ].wrapS = THREE.RepeatWrapping; 
    T_NORM[ propt ].wrapT = THREE.RepeatWrapping; 
    T_NORM_STRINGS.push( propt );

  }


  var SONG_PARAMS = [

    { 
      title: 'At Night / Miss You',
      file:'audio/atNight.mp3',

      physicsParams:{
        uFloatForce: 3000,
        uRadiusMultiplier: 1.8,
        uSpringForce: 10,
        uSpringDist: 1,
        uRepelMultiplier: 10,
      },

      renderParams:{
        t_iri: T_IRI.rainbowLight,
        t_iri2: T_IRI.gold,
        girth: 2,
        headMultiplier: 30.5,
        texScale: .001,
        normalScale: .02,
        tNormal: T_NORM.moss

      },
      

       ballParams: {
        springDistance: 5800,
        dampening: 2.5,
        springForceMultiplier: .0001,
        centerForceMultiplier: .000001,
        centerSize:600,
        maxVel: 5,
      },


      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.gold,

      },

      t_iri: T_IRI.gold,
      t_normal: T_NORM.moss,
      baseShape: 'spiral'


    },
    
    { 
      title: 'Crush #4 / Slow Dance',
      file:'audio/slowDance.mp3',
       physicsParams:{

        uFloatForce: 3000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 100,
        uSpringDist: 100,
        uRepelMultiplier: 200,
      
      },
      
      renderParams:{
        t_iri: T_IRI.gold,
        t_iri2: T_IRI.turq2,
        girth: 2.4,
        headMultiplier: 6.3,
        texScale:0.01,
        normalScale:.3

      },

      ballParams:{
        springDistance: 3000,
        dampening: 1.3,
        springForceMultiplier: .000002,
        centerForceMultiplier: .0000001,
                centerSize:600,

        maxVel:10
      },

      centerParams:{

        tNormal: T_NORM.carbon,
        t_iri: T_IRI.red,

      },

      t_iri: T_IRI.red,
      t_normal: T_NORM.sand,
      baseShape: 'ring'
    },
    
    { 
      title: 'Only Used To',
      file:'audio/only.mp3',

      ballParams: {
        springDistance: 8800,
        dampening: 2.5,
        springForceMultiplier: .0001,
        centerForceMultiplier: .000001,
               centerSize:600,

        maxVel: 15,
      },


      
      physicsParams:{

        uFloatForce: 1000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 100,
        uSpringDist: 93,
        uRepelMultiplier: 10, 
      
      },

      
      renderParams:{
        t_iri: T_IRI.turq ,
        t_iri2: T_IRI.pinkRed,
        girth: 3,
        headMultiplier: 13.5,
        texScale:0.001,
        normalScale:.1,
        tNormal:T_NORM.moss
        

      },
      
      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.pinkRed,

      },

      t_iri: T_IRI.pinkRed,
      t_normal: T_NORM.moss,

      baseShape: 'random'
      

    },
    
    { 
      title: 'Give You',
      file:'audio/giveYou.mp3',

      ballParams: {
        springDistance: 2600,
        dampening: 1.63,
        springForceMultiplier: .0005,
        centerForceMultiplier: .000001,
                centerSize:600,

        maxVel: 17,
      },

      physicsParams:{

        uFloatForce: 1000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 50,
        uSpringDist: 100,
        uRepelMultiplier: 10, 
      
      },
      renderParams:{
        t_iri: T_IRI.gold,
        t_iri2: T_IRI.red,
        girth: 4.4,
        headMultiplier: 4.6,
        texScale:.011,
        normalScale:.26,
        tNormal:T_NORM.moss

      },
      
      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.blue,

      },

      t_iri: T_IRI.blue,
      t_normal: T_NORM.moss,
        baseShape: 'sphere'




    },
    
    { 
      title: 'Needs',
      file:'audio/needs.mp3',

      ballParams: {
        springDistance: 2000,
        dampening: 1.999999,
        springForceMultiplier: .001,
        centerForceMultiplier: .000001,
               centerSize:600,
        maxVel: 10,
      },

      physicsParams:{

        uFloatForce: 10000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 70,
        uSpringDist: .1,
        uRepelMultiplier: 200,
      
      },
      renderParams:{
        t_iri: T_IRI.gold,
        t_iri2: T_IRI.purpleBright,
        girth: 3,
        headMultiplier:6.5,
        texScale:.004,
        normalScale:.1,
        tNormal:T_NORM.carbon

      },
      
      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.purpleBright,

      },

      t_iri: T_IRI.purpleBright,
      t_normal: T_NORM.moss,
      baseShape: 'tripleRing'



    },

  ]

  // Global Variables for THREE.JS
  var container , camera, scene, renderer , stats;

  // Global variable for leap
  var frame, controller;

  // Setting up how big we want the scene to be
  var sceneSize = 5000;

  var handGeo;
  var skullGeo;
  var tendrilGeo;

  var loaded = 0;
  var neededToLoad = 1;

  var tendrils;

  var TMP_VECTOR = new THREE.Vector3();
  var MAX_VEL = 20;

  var oCamPos = new THREE.Vector3();

  var clock = new THREE.Clock();

  var gui = new dat.GUI({autoPlace:false});

  gui.close();

  var guiContainer = document.getElementById('GUI');
  guiContainer.appendChild(gui.domElement);

  var audioController = new AudioController();


  var NOTFIRSTFRAME; // Hack for some weird GL thing...
 // audioController.mute.gain.value = 0;

 // var stream = new Stream(  'audio/you.mp3',audioController  );

 /* var userMedia = new UserAudio( audioController );
  console.log( userMedia );

  userMedia.onStreamCreated = function(){
    onLoad();
  }*/
  
 
  var timer = { type:"f" , value:0 }
  var dT = { type:"f" , value:0 }

  var repelPositions = [];
  var repelVelocities = [];
  var repelRadii = [];
  var repelObjects = [];


 var shaders = new ShaderLoader('shaders');

  shaders.load( 'fs-center' , 'center' , 'fragment' );
  shaders.load( 'vs-center' , 'center' , 'vertex' );
  shaders.load( 'fs-curve' , 'curve' , 'fragment' );
  shaders.load( 'vs-curve' , 'curve' , 'vertex' );
  shaders.load( 'fs-link' , 'link' , 'fragment' );
  shaders.load( 'vs-link' , 'link' , 'vertex' );
  shaders.load( 'fs-tendril' , 'tendril' , 'fragment' );
  shaders.load( 'vs-tendril' , 'tendril' , 'vertex' );
  shaders.load( 'fs-tendrilLine' , 'tendrilLine' , 'fragment' );
  shaders.load( 'vs-tendrilLine' , 'tendrilLine' , 'vertex' );

  shaders.load( 'tendrilSim' , 'tendrilSim' , 'simulation' );

  loader.beginLoading();
  shaders.shaderSetLoaded = function(){
  //  init();
    loader.endLoading();
  }



 /* var PARAMS = {


    // Sim
    maxVelTendrils:1000,
    audioPowerSim:2,
    audioAmountSim:.75,
    springForce:100,
    springDist:100,
    repelMultiplier:50,
    flowMultiplier:0,

    repelRadius: 500, // TODO: need to loop through and set

    //TendrilRender
    girth:5,
    headMultiplier:2,
    audioPowerRender:2,
    audioAmountRender:.75,
    springForce:100,
    springDist:100,
    repelMultiplier:50,
    flowMultiplier:0,

    texScale: .1,
    normalScale: 5.,

    headIri: t_red,
    headNormal: n_ice,
  
    shaftIri: t_orangeTurq,
    shaftNormal: n_moss,



    // REPEL balls
    repelRadius: 500,
    
    ballsMaxVel: 500,

    ballsIri: t_wet,
    ballsNormal: n_moss,
    ballsCenterAttract: 100,
    ballsSpringLength: 1000,
    ballsDampening: .9999


  }*/


  var ballParams = {
    springDistance: 2000,
    dampening: .999999,
    springForceMultiplier: .001,
    centerForceMultiplier: .000001,
    centerSize:300,
    maxVel: 30,
  }

  var ballGui = gui.addFolder( 'Ball Params' );

  ballGui.add( ballParams , 'springDistance' ).onChange( function(){
    for( var i = 0; i < LINKS.length; i++ ){
      LINKS[i].updateParams( ballParams );
    }
  });

  ballGui.add( ballParams , 'dampening' ).onChange( function(){
    for( var i = 0; i < LINKS.length; i++ ){
      LINKS[i].updateParams( ballParams );
    }
  });
  
  ballGui.add( ballParams , 'springForceMultiplier' ).onChange( function(){
    for( var i = 0; i < LINKS.length; i++ ){
      LINKS[i].updateParams( ballParams );
    }
  });
  
  ballGui.add( ballParams , 'centerForceMultiplier' ).onChange( function(){
    for( var i = 0; i < LINKS.length; i++ ){
      LINKS[i].updateParams( ballParams );
    }
  });
  
  ballGui.add( ballParams , 'centerSize' ).onChange( function(){
    for( var i = 0; i < LINKS.length; i++ ){
      LINKS[i].updateParams( ballParams );
    }
  });

  ballGui.add( ballParams , 'maxVel' ).onChange( function(){
    for( var i = 0; i < LINKS.length; i++ ){
      LINKS[i].updateParams( ballParams );
    }
  });







  // on repel radius change, loop through repel radii

  function init(){
   
    textCreator = new TextCreator( 100 );

    controller = new Leap.Controller();

    scene = new THREE.Scene();
    
    camera = new THREE.PerspectiveCamera( 
      50 ,
      window.innerWidth / window.innerHeight,
      sceneSize / 100 ,
      sceneSize * 40
    );

    // placing our camera position so it can see everything
    camera.position.z = sceneSize ;
    camera.position.x = sceneSize / 4;

    camera.velocity = new THREE.Vector3();

    // Getting the container in the right location
    container     = document.createElement( 'div' );
    container.id  = 'container';
    
    document.body.appendChild( container );


    // Getting the stats in the right position
    stats = new Stats();
    stats.domElement.id = 'stats';
    //document.body.appendChild( stats.domElement );


    // Setting up our Renderer
    renderer = new THREE.WebGLRenderer();

    renderer.setSize( window.innerWidth, window.innerHeight );
    container.appendChild( renderer.domElement );


    // Making sure our renderer is always the right size
    window.addEventListener( 'resize', onWindowResize , false );

    initMechanics();
  

  /*  var mesh = new THREE.Mesh(
    new THREE.CubeGeometry( 1000 , 1000 , 1000 ),
    new THREE.MeshBasicMaterial({map:audioController.texture })
    );
    scene.add( mesh );*/
   
    for( var i = 0; i< SONG_PARAMS.length; i++ ){
      var l = new Link(i , SONG_PARAMS.length , SONG_PARAMS[i] );
      l.activate();
    }


    // Center repulsion
    repelPositions.push( new THREE.Vector3() );
    repelVelocities.push( new THREE.Vector3() );
    repelRadii.push( 340 );
    

    //camera repulsion
    repelPositions.push( camera.position );
    repelVelocities.push( new THREE.Vector3() );
    repelRadii.push( 0 );

    camera.repelID = repelPositions.length - 1;

    tendrils = new Tendrils({

      repelPositions: repelPositions,
      repelVelocities: repelVelocities,
      repelRadii: repelRadii,
      

    });

    tendrils.activate();

    objectRotator = new ObjectRotator( tendrils.center );
    controller.connect();

    for( var i = 0; i < LINKS.length; i++ ){

      LINKS[i].centerPos = tendrils.center.position;

    }


    addSocialMedia( SOCIAL_MEDIA );

  }


  function animate(){

    audioController.update();

    objectRotator.update();

    dT.value = clock.getDelta();
    timer.value += dT.value;

    updateMechanics();

    //if( !LINK_INTERSECTED ){
      
      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].updatePhysics();

      }

      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].updatePosition();

      }

   // }
   
    tendrils.update();
    stats.update();

    renderer.render( scene , camera );

    requestAnimationFrame( animate );


    // Hack to make materials disappear proper
    if( !NOTFIRSTFRAME ){

     // console.log('asdas');
      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].hoverOut();

      }
      LINKS[4].select();

      NOTFIRSTFRAME = true;
    }
  }

  function intersectLinks(){




  }

  // Resets the renderer to be the proper size
  function onWindowResize(){

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

  }

  loader.onStart = function(){

    init();
    animate();

  }


</script>


</body>
</html>
