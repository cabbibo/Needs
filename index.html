<html>

<head>
  <style>

    
    @font-face {
      font-family: "GeoSans";
      src: url("lib/GeosansLight.ttf");
    }
    html{ color:#fff; background:#000; font-family:"GeoSans" }

    #container{
      width      : 100%;
      height     : 100%;
      position   : absolute;
      top        : 0px;
      left       : 0px;
      background : #000;
    }

    #stats{
      position  : absolute;
      bottom    : 0px;
      right     : 0px;
      z-index   : 999;
    }

    a{
color: #fff;
position: absolute;
z-index: 999;

    }

    #linkInfo{

      position:absolute;
      display:block;
      width:20px;
      height:20px;
      background:#fff;
      z-index : 999;

    }
  </style>
</head>
<body>

  <div id="loading"> LOADING MODELS </div>

  <div id="linkInfo"></div>

<script src = "lib/leap.js"               ></script>
<script src = "lib/underscore.js"         ></script>
<script src = "lib/three.js"              ></script>
<script src = "lib/jquery.min.js"         ></script>
<script src = "lib/stats.min.js"          ></script>
<script src = "lib/TrackballControls.js"  ></script>
<script src = "lib/ShaderLoader.js"       ></script>
<script src = "lib/Stream.js"             ></script>
<script src = "lib/UserAudio.js"          ></script>
<script src = "lib/AudioController.js"    ></script>
<script src = "lib/AudioTexture.js"       ></script>
<script src = "lib/PhysicsRenderer.js"    ></script>
<script src = "lib/TextCreator.js"        ></script>

<script src = "js/ObjectRotator.js"       ></script>
<script src = "js/Tendrils.js"            ></script>
<script src = "js/Link.js"                ></script>
<script src = "js/LinkArch.js"            ></script>
<script src = "js/mechanics.js"           ></script>


<script>


  var SONG_PARAMS = [

    { 
      title: 'At Night / Miss You',
      file:'audio/atNight.mp3',
    },
    
    { 
      title: 'Crush #4 / Slow Dance',
      file:'audio/slowDance.mp3',
    },
    
    { 
      title: 'Only Used To',
      file:'audio/only.mp3',
    },
    
    { 
      title: 'Give You',
      file:'audio/giveYou.mp3',
    },
    
    { 
      title: 'Needs',
      file:'audio/needs.mp3',
    },

  ]

  console.log('Loading');

  // Global Variables for THREE.JS
  var container , camera, scene, renderer , stats;

  // Global variable for leap
  var frame, controller;

  // Setting up how big we want the scene to be
  var sceneSize = 5000;

  var handGeo;
  var skullGeo;
  var tendrilGeo;

  var loaded = 0;
  var neededToLoad = 1;

  var tendrils;

  var TMP_VECTOR = new THREE.Vector3();
  var MAX_VEL = 20;

  var oCamPos = new THREE.Vector3();

  var clock = new THREE.Clock();


  var audioController = new AudioController();

 // audioController.mute.gain.value = 0;

 // var stream = new Stream(  'audio/you.mp3',audioController  );

 /* var userMedia = new UserAudio( audioController );
  console.log( userMedia );

  userMedia.onStreamCreated = function(){
    onLoad();
  }*/
  
 
  var timer = { type:"f" , value:0 }
  var dT = { type:"f" , value:0 }

  var repelPositions = [];
  var repelVelocities = [];
  var repelRadii = [];
  var repelObjects = [];


 var shaders = new ShaderLoader('shaders');

  shaders.load( 'fs-center' , 'center' , 'fragment' );
  shaders.load( 'vs-center' , 'center' , 'vertex' );
  shaders.load( 'fs-curve' , 'curve' , 'fragment' );
  shaders.load( 'vs-curve' , 'curve' , 'vertex' );
  shaders.load( 'fs-link' , 'link' , 'fragment' );
  shaders.load( 'vs-link' , 'link' , 'vertex' );
  shaders.load( 'fs-tendril' , 'tendril' , 'fragment' );
  shaders.load( 'vs-tendril' , 'tendril' , 'vertex' );
  shaders.load( 'fs-tendrilLine' , 'tendrilLine' , 'fragment' );
  shaders.load( 'vs-tendrilLine' , 'tendrilLine' , 'vertex' );

  shaders.load( 'tendrilSim' , 'tendrilSim' , 'simulation' );
 
  shaders.shaderSetLoaded = function(){
   onLoad();
  }

  var t_red         = THREE.ImageUtils.loadTexture( 'img/iri/red.png' );
  var t_turq        = THREE.ImageUtils.loadTexture( 'img/iri/turq.png' );
  var t_pinkRed     = THREE.ImageUtils.loadTexture( 'img/iri/pinkRed.png' );
  var t_gold        = THREE.ImageUtils.loadTexture( 'img/iri/gold.png' );
  var t_combo       = THREE.ImageUtils.loadTexture( 'img/iri/combo.png' );
  var t_yellowPurp  = THREE.ImageUtils.loadTexture( 'img/iri/neonYellowPurp.png' );
  var t_wet         = THREE.ImageUtils.loadTexture( 'img/iri/greenBluePurp.png' );
  var t_orangeTurq  = THREE.ImageUtils.loadTexture( 'img/iri/orangeTurq.png' );

  var n_carbon = THREE.ImageUtils.loadTexture( 'img/normals/carbonFiber.png' );
  var n_snow   = THREE.ImageUtils.loadTexture( 'img/normals/ice-snow.jpg' );
  var n_sand   = THREE.ImageUtils.loadTexture( 'img/normals/sand.png' );
  var n_rock   = THREE.ImageUtils.loadTexture( 'img/normals/rock.png' );
  var n_ice    = THREE.ImageUtils.loadTexture( 'img/normals/7723-normal.jpg' );
  var n_moss   = THREE.ImageUtils.loadTexture( 'img/normals/moss_normal_map.jpg' );

  var PARAMS = {


    // Sim
    maxVelTendrils:1000,
    audioPowerSim:2,
    audioAmountSim:.75,
    springForce:100,
    springDist:100,
    repelMultiplier:50,
    flowMultiplier:0,

    repelRadius: 500, // TODO: need to loop through and set

    //TendrilRender
    girth:5,
    headMultiplier:2,
    audioPowerRender:2,
    audioAmountRender:.75,
    springForce:100,
    springDist:100,
    repelMultiplier:50,
    flowMultiplier:0,

    texScale: .1,
    normalScale: 5.,

    headIri: t_red,
    headNormal: n_ice,
  
    shaftIri: t_orangeTurq,
    shaftNormal: n_moss,



    // REPEL balls
    repelRadius: 500,
    
    ballsMaxVel: 500,

    ballsIri: t_wet,
    ballsNormal: n_moss,
    ballsCenterAttract: 100,
    ballsSpringLength: 1000,
    ballsDampening: .9999




  }


  // on repel radius change, loop through repel radii

  function init(){
   
    textCreator = new TextCreator( 100 );

    controller = new Leap.Controller();

    scene = new THREE.Scene();
    
    camera = new THREE.PerspectiveCamera( 
      50 ,
      window.innerWidth / window.innerHeight,
      sceneSize / 100 ,
      sceneSize * 40
    );

    // placing our camera position so it can see everything
    camera.position.z = sceneSize ;
    camera.position.x = sceneSize / 4;

    camera.velocity = new THREE.Vector3();

    // Getting the container in the right location
    container     = document.createElement( 'div' );
    container.id  = 'container';
    
    document.body.appendChild( container );


    // Getting the stats in the right position
    stats = new Stats();
    stats.domElement.id = 'stats';
    document.body.appendChild( stats.domElement );


    // Setting up our Renderer
    renderer = new THREE.WebGLRenderer();

    renderer.setSize( window.innerWidth, window.innerHeight );
    container.appendChild( renderer.domElement );


    // Making sure our renderer is always the right size
    window.addEventListener( 'resize', onWindowResize , false );

    initMechanics();
  

   
    for( var i = 0; i< SONG_PARAMS.length; i++ ){
      var l = new Link(i , SONG_PARAMS.length , SONG_PARAMS[i] );
      l.activate();
    }


    // Center repulsion
    repelPositions.push( new THREE.Vector3() );
    repelVelocities.push( new THREE.Vector3() );
    repelRadii.push( 340 );
    

    //camera repulsion
    repelPositions.push( camera.position );
    repelVelocities.push( new THREE.Vector3() );
    repelRadii.push( 340 );

    camera.repelID = repelPositions.length - 1;

    console.log( 'EFASD');
    console.log( repelRadii.length );



    tendrils = new Tendrils({

      repelPositions: repelPositions,
      repelVelocities: repelVelocities,
      repelRadii: repelRadii,
      

    });

    tendrils.activate();

    objectRotator = new ObjectRotator( tendrils.center );
    controller.connect();


    
    var tNormal   = THREE.ImageUtils.loadTexture( 'img/normals/moss_normal_map.jpg' );

    tNormal.wrapS = THREE.RepeatWrapping; 
    tNormal.wrapT = THREE.RepeatWrapping; 
  
    var uniforms = {

      lightPos: { type:"v3" , value:new THREE.Vector3() },
      tNormal:{type:"t",value:tNormal},
      time:timer,
      t_iri:{ type:"t" , value: t_yellowPurp },
      t_audio:{ type:"t" , value: audioController.texture },
      texScale:{type:"f" , value:.001},
      normalScale:{type:"f" , value:.8},

    }

    vertexShader   = shaders.vertexShaders.curve;
    fragmentShader = shaders.fragmentShaders.curve;

    var material = new THREE.ShaderMaterial({

      uniforms: uniforms,
      vertexShader: vertexShader,
      fragmentShader: fragmentShader

    });

  }


  function animate(){

    audioController.update();

    objectRotator.update();

    dT.value = clock.getDelta();
    timer.value += dT.value;

    updateMechanics();

    //if( !LINK_INTERSECTED ){
      
      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].updatePhysics();

      }

      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].updatePosition();

      }

   // }
   
    tendrils.update();
    stats.update();

    renderer.render( scene , camera );

    requestAnimationFrame( animate );

  }

  function intersectLinks(){




  }

  // Resets the renderer to be the proper size
  function onWindowResize(){

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

  }

  function onLoad(){


    loaded ++;

    if( loaded === neededToLoad ){

      init();
      animate();
      //stream.play();

    }

  }
</script>


</body>
</html>
