<html>

<head>
  <style>

    
    @font-face {
      font-family: "GeoSans";
      src: url("lib/GeosansLight.ttf");
    }
    html{ color:#fff; background:#000; font-family:"GeoSans" }

    #container{
      width      : 100%;
      height     : 100%;
      position   : absolute;
      top        : 0px;
      left       : 0px;
      background : #000;
    }

    #container{ position:absolute; left:0px; top:0px; z-index:0; width:100%; height:100%; display:block; overflow:hidden}
      body{ margin:0px; }
    #stats{
      position  : absolute;
      bottom    : 0px;
      right     : 0px;
      z-index   : 999;
    }

    a{
      color: #fff;
      position: absolute;
      z-index: 999;
    }

    #linkInfo{

      position:absolute;
      display:block;
      width:20px;
      height:20px;
      background:#fff;
      z-index : 999;

    }


    #GUI{

      position:fixed;
      right:0px;
      top:0px;
      z-index:999;

    }
  </style>
</head>
<body>

  <div id="loading"> LOADING MODELS </div>

  <div id="linkInfo"></div>
  <div id="GUI"></div>

<script src = "lib/leap.js"               ></script>
<script src = "lib/underscore.js"         ></script>
<script src = "lib/three.js"              ></script>
<script src = "lib/dat.gui.min.js"         ></script>
<script src = "lib/jquery.min.js"         ></script>
<script src = "lib/stats.min.js"          ></script>
<script src = "lib/TrackballControls.js"  ></script>
<script src = "lib/ShaderLoader.js"       ></script>
<script src = "lib/Stream.js"             ></script>
<script src = "lib/UserAudio.js"          ></script>
<script src = "lib/AudioController.js"    ></script>
<script src = "lib/AudioTexture.js"       ></script>
<script src = "lib/PhysicsRenderer.js"    ></script>
<script src = "lib/TextCreator.js"        ></script>

<script src = "js/ObjectRotator.js"       ></script>
<script src = "js/Tendrils.js"            ></script>
<script src = "js/Link.js"                ></script>
<script src = "js/LinkArch.js"            ></script>
<script src = "js/mechanics.js"           ></script>


<script>


  
  var T_IRI = {}

  T_IRI.red         = THREE.ImageUtils.loadTexture( 'img/iri/red.png' );
  T_IRI.turq        = THREE.ImageUtils.loadTexture( 'img/iri/turq.png' );
  T_IRI.pinkRed     = THREE.ImageUtils.loadTexture( 'img/iri/pinkRed.png' );
  T_IRI.gold        = THREE.ImageUtils.loadTexture( 'img/iri/gold.png' );
  T_IRI.combo       = THREE.ImageUtils.loadTexture( 'img/iri/combo.png' );
  T_IRI.yellowPurp  = THREE.ImageUtils.loadTexture( 'img/iri/neonYellowPurp.png' );
  T_IRI.wet         = THREE.ImageUtils.loadTexture( 'img/iri/greenBluePurp.png' );
  T_IRI.orangeTurq  = THREE.ImageUtils.loadTexture( 'img/iri/orangeTurq.png' );
  T_IRI.purpleBright = THREE.ImageUtils.loadTexture( 'img/iri/purpleBright.png' );
  T_IRI.blue = THREE.ImageUtils.loadTexture( 'img/iri/blue.png' );
  T_IRI.rainbow = THREE.ImageUtils.loadTexture( 'img/iri/rainbow.png' );
  T_IRI.rainbowLight  = THREE.ImageUtils.loadTexture( 'img/iri/rainbowLight.png' );
  T_IRI.turq2  = THREE.ImageUtils.loadTexture( 'img/iri/turq2.png' );

  var T_IRI_STRINGS = [];

  for( var propt in T_IRI ){

    console.log( propt );
    T_IRI_STRINGS.push( propt );

  }

  var T_NORM = {};
  
  T_NORM.carbon = THREE.ImageUtils.loadTexture( 'img/normals/carbonFiber.png' );
  T_NORM.snow   = THREE.ImageUtils.loadTexture( 'img/normals/ice-snow.jpg' );
  T_NORM.sand   = THREE.ImageUtils.loadTexture( 'img/normals/sand.png' );
  T_NORM.ice    = THREE.ImageUtils.loadTexture( 'img/normals/7723-normal.jpg' );
  T_NORM.moss   = THREE.ImageUtils.loadTexture( 'img/normals/moss_normal_map.jpg' );

  var T_NORM_STRINGS = [];

  for( var propt in T_NORM ){

    T_NORM[ propt ].wrapS = THREE.RepeatWrapping; 
    T_NORM[ propt ].wrapT = THREE.RepeatWrapping; 
    T_NORM_STRINGS.push( propt );

  }


  var SONG_PARAMS = [

    { 
      title: 'At Night / Miss You',
      file:'audio/atNight.mp3',

      physicsParams:{
        uFloatForce: 3000,
        uRadiusMultiplier: 1.8,
        uSpringForce: 10,
        uSpringDist: 1,
        uRepelMultiplier: 10,
      },

      renderParams:{
        t_iri: T_IRI.rainbowLight,
        t_iri2: T_IRI.gold,
        girth: 2,
        headMultiplier: 30.5,
        texScale: .001,
        normalScale: .02,
        tNormal: T_NORM.moss

      },
      

      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.gold,

      },

      t_iri: T_IRI.gold,
      t_normal: T_NORM.moss


    },
    
    { 
      title: 'Crush #4 / Slow Dance',
      file:'audio/slowDance.mp3',
       physicsParams:{

        uFloatForce: 3000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 100,
        uSpringDist: 100,
        uRepelMultiplier: 200,
      
      },
      
      renderParams:{
        t_iri: T_IRI.gold,
        t_iri2: T_IRI.turq2,
        girth: 2.4,
        headMultiplier: 6.3,
        texScale:0.01,
        normalScale:.3

      },
      
      


      centerParams:{

        tNormal: T_NORM.carbon,
        t_iri: T_IRI.gold,

      },

      t_iri: T_IRI.gold,
      t_normal: T_NORM.sand
    },
    
    { 
      title: 'Only Used To',
      file:'audio/only.mp3',
       physicsParams:{

        uFloatForce: 1000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 100,
        uSpringDist: 93,
        uRepelMultiplier: 10, 
      
      },

      
      renderParams:{
        t_iri: T_IRI.turq ,
        t_iri2: T_IRI.pinkRed,
        girth: 3,
        headMultiplier: 13.5,
        texScale:0.001,
        normalScale:.1

      },
      
      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.pinkRed,

      },

      t_iri: T_IRI.pinkRed,
      t_normal: T_NORM.moss


    },
    
    { 
      title: 'Give You',
      file:'audio/giveYou.mp3',
      physicsParams:{

        uFloatForce: 1000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 50,
        uSpringDist: 100,
        uRepelMultiplier: 10, 
      
      },
      renderParams:{
        t_iri: T_IRI.gold,
        t_iri2: T_IRI.red,
        girth: 4.4,
        headMultiplier: 4.6,
        texScale:.011,
        normalScale:.26,
        tNormal:T_NORM.moss

      },
      
      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.blue,

      },

      t_iri: T_IRI.blue,
      t_normal: T_NORM.moss




    },
    
    { 
      title: 'Needs',
      file:'audio/needs.mp3',
      physicsParams:{

        uFloatForce: 10000,
        uRadiusMultiplier: 1.4,
        uSpringForce: 70,
        uSpringDist: .1,
        uRepelMultiplier: 200,
      
      },
      renderParams:{
        t_iri: T_IRI.gold,
        t_iri2: T_IRI.purpleBright,
        girth: 3,
        headMultiplier: 20.5,
        texScale:.004,
        normalScale:.1,
        tNormal:T_NORM.carbon

      },
      
      centerParams:{

        tNormal: T_NORM.moss,
        t_iri: T_IRI.purpleBright,

      },

      t_iri: T_IRI.purpleBright,
      t_normal: T_NORM.moss



    },

  ]

  // Global Variables for THREE.JS
  var container , camera, scene, renderer , stats;

  // Global variable for leap
  var frame, controller;

  // Setting up how big we want the scene to be
  var sceneSize = 5000;

  var handGeo;
  var skullGeo;
  var tendrilGeo;

  var loaded = 0;
  var neededToLoad = 1;

  var tendrils;

  var TMP_VECTOR = new THREE.Vector3();
  var MAX_VEL = 20;

  var oCamPos = new THREE.Vector3();

  var clock = new THREE.Clock();

  var gui = new dat.GUI({autoPlace:false});

  var guiContainer = document.getElementById('GUI');
  guiContainer.appendChild(gui.domElement);

  var audioController = new AudioController();

  var NOTFIRSTFRAME;
 // audioController.mute.gain.value = 0;

 // var stream = new Stream(  'audio/you.mp3',audioController  );

 /* var userMedia = new UserAudio( audioController );
  console.log( userMedia );

  userMedia.onStreamCreated = function(){
    onLoad();
  }*/
  
 
  var timer = { type:"f" , value:0 }
  var dT = { type:"f" , value:0 }

  var repelPositions = [];
  var repelVelocities = [];
  var repelRadii = [];
  var repelObjects = [];


 var shaders = new ShaderLoader('shaders');

  shaders.load( 'fs-center' , 'center' , 'fragment' );
  shaders.load( 'vs-center' , 'center' , 'vertex' );
  shaders.load( 'fs-curve' , 'curve' , 'fragment' );
  shaders.load( 'vs-curve' , 'curve' , 'vertex' );
  shaders.load( 'fs-link' , 'link' , 'fragment' );
  shaders.load( 'vs-link' , 'link' , 'vertex' );
  shaders.load( 'fs-tendril' , 'tendril' , 'fragment' );
  shaders.load( 'vs-tendril' , 'tendril' , 'vertex' );
  shaders.load( 'fs-tendrilLine' , 'tendrilLine' , 'fragment' );
  shaders.load( 'vs-tendrilLine' , 'tendrilLine' , 'vertex' );

  shaders.load( 'tendrilSim' , 'tendrilSim' , 'simulation' );
 
  shaders.shaderSetLoaded = function(){
   onLoad();
 }



 /* var PARAMS = {


    // Sim
    maxVelTendrils:1000,
    audioPowerSim:2,
    audioAmountSim:.75,
    springForce:100,
    springDist:100,
    repelMultiplier:50,
    flowMultiplier:0,

    repelRadius: 500, // TODO: need to loop through and set

    //TendrilRender
    girth:5,
    headMultiplier:2,
    audioPowerRender:2,
    audioAmountRender:.75,
    springForce:100,
    springDist:100,
    repelMultiplier:50,
    flowMultiplier:0,

    texScale: .1,
    normalScale: 5.,

    headIri: t_red,
    headNormal: n_ice,
  
    shaftIri: t_orangeTurq,
    shaftNormal: n_moss,



    // REPEL balls
    repelRadius: 500,
    
    ballsMaxVel: 500,

    ballsIri: t_wet,
    ballsNormal: n_moss,
    ballsCenterAttract: 100,
    ballsSpringLength: 1000,
    ballsDampening: .9999


  }*/


  // on repel radius change, loop through repel radii

  function init(){
   
    textCreator = new TextCreator( 100 );

    controller = new Leap.Controller();

    scene = new THREE.Scene();
    
    camera = new THREE.PerspectiveCamera( 
      50 ,
      window.innerWidth / window.innerHeight,
      sceneSize / 100 ,
      sceneSize * 40
    );

    // placing our camera position so it can see everything
    camera.position.z = sceneSize ;
    camera.position.x = sceneSize / 4;

    camera.velocity = new THREE.Vector3();

    // Getting the container in the right location
    container     = document.createElement( 'div' );
    container.id  = 'container';
    
    document.body.appendChild( container );


    // Getting the stats in the right position
    stats = new Stats();
    stats.domElement.id = 'stats';
    document.body.appendChild( stats.domElement );


    // Setting up our Renderer
    renderer = new THREE.WebGLRenderer();

    renderer.setSize( window.innerWidth, window.innerHeight );
    container.appendChild( renderer.domElement );


    // Making sure our renderer is always the right size
    window.addEventListener( 'resize', onWindowResize , false );

    initMechanics();
  

   
    for( var i = 0; i< SONG_PARAMS.length; i++ ){
      var l = new Link(i , SONG_PARAMS.length , SONG_PARAMS[i] );
      l.activate();
    }


    // Center repulsion
    repelPositions.push( new THREE.Vector3() );
    repelVelocities.push( new THREE.Vector3() );
    repelRadii.push( 340 );
    

    //camera repulsion
    repelPositions.push( camera.position );
    repelVelocities.push( new THREE.Vector3() );
    repelRadii.push( 340 );

    camera.repelID = repelPositions.length - 1;

    tendrils = new Tendrils({

      repelPositions: repelPositions,
      repelVelocities: repelVelocities,
      repelRadii: repelRadii,
      

    });

    tendrils.activate();

    objectRotator = new ObjectRotator( tendrils.center );
    controller.connect();


    
    /*var tNormal   = THREE.ImageUtils.loadTexture( 'img/normals/moss_normal_map.jpg' );

    tNormal.wrapS = THREE.RepeatWrapping; 
    tNormal.wrapT = THREE.RepeatWrapping; 
  
    var uniforms = {

      lightPos: { type:"v3" , value:new THREE.Vector3() },
      tNormal:{type:"t",value:tNormal},
      time:timer,
      t_iri:{ type:"t" , value: t_yellowPurp },
      t_audio:{ type:"t" , value: audioController.texture },
      texScale:{type:"f" , value:.001},
      normalScale:{type:"f" , value:.8},

    }

    vertexShader   = shaders.vertexShaders.curve;
    fragmentShader = shaders.fragmentShaders.curve;

    var material = new THREE.ShaderMaterial({

      uniforms: uniforms,
      vertexShader: vertexShader,
      fragmentShader: fragmentShader

    });*/

    for( var i = 0; i < LINKS.length; i++ ){

      //LINKS[i].hoverOut();

    }
  }


  function animate(){

    audioController.update();

    objectRotator.update();

    dT.value = clock.getDelta();
    timer.value += dT.value;

    updateMechanics();

    //if( !LINK_INTERSECTED ){
      
      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].updatePhysics();

      }

      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].updatePosition();

      }

   // }
   
    tendrils.update();
    stats.update();

    renderer.render( scene , camera );

    requestAnimationFrame( animate );


    // Hack to make materials disappear proper
    if( !NOTFIRSTFRAME ){
      console.log('asdas');
      for( var i = 0; i < LINKS.length; i++ ){

        LINKS[i].hoverOut();

      }

      NOTFIRSTFRAME = true;
    }
  }

  function intersectLinks(){




  }

  // Resets the renderer to be the proper size
  function onWindowResize(){

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

  }

  function onLoad(){


    loaded ++;

    if( loaded === neededToLoad ){

      init();
      animate();
      //stream.play();

    }

  }
</script>


</body>
</html>
